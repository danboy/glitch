/*! glitch 2014-03-03 */
var Filter=function(a){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.image=a};Filter.prototype={imageData:function(){var a=this.image.width,b=this.image.height;return this.canvas.setAttribute("width",a),this.canvas.setAttribute("height",b),this.context.drawImage(this.image,0,0),this.context.getImageData(0,0,a,b)},applyFilters:function(a,b){this.imageData=this.imageData();for(var c=a.length-1;c>=0;c-=1)this.filters[a[c]](this.imageData,this.canvas,b);return this.imageData},filters:{unfiltered:function(a){return a},grayscale:function(a){for(var b=a.data,c=0;c<b.length;c+=4){var d=b[c],e=b[c+1],f=b[c+2],g=.2126*d+.7152*e+.0722*f;b[c]=b[c+1]=b[c+2]=g}return a},brightness:function(a){for(var b=95,c=a.data,d=0;d<c.length;d+=4)c[d]+=b,c[d+1]+=b,c[d+2]+=b;return a},threshold:function(a,b){b=b||11;for(var c=a.data,d=0;d<c.length;d+=4){var e=c[d],f=c[d+1],g=c[d+2],h=.2126*e+.7152*f+.0722*g>=b?255:0;c[d]=c[d+1]=c[d+2]=h}return a},noise:function(a){for(var b=a.data,c=0;c<b.length;c+=1){var d=b[Math.floor(Math.random()*b.length)],e=b[Math.floor(Math.random()*d)];b[Math.floor(Math.random()*b.length)]=b[e]}return a},redNoise:function(a){for(var b=a.data,c=b.length,d=0;c>d;d+=4){var e=Math.floor(Math.random()*d),f=Math.floor(Math.random()*e);b[d]=b[f]}return a},red:function(a){for(var b=a.data,c=0;c<b.length;c+=4){var d=b[c],e=b[c+1],f=b[c+2];b[c]=(d+e+f)/3,b[c+1]=b[c+2]=0}return a},glitch:function(a,b,c){for(var d=250*c,e=a.data,f=b.height,g=b.width,h=Math.floor(Math.random()*d),i=0;2>i;i++)for(var j=h*i,k=h*i,l=0;f>l;l++)for(var m=0;g>m;m++){var n=e[4*(g*l+m)],o=e[4*(g*l+m)+1],p=e[4*(g*l+m)+2];e[4*(g*l+m)]=n,e[4*(g*l+m)+j]=o,e[4*(g*l+m)+k]=p}return a},pixelate:function(a,b){var c=b.getContext("2d");c.mozImageSmoothingEnabled=!1,c.webkitImageSmoothingEnabled=!1,c.imageSmoothingEnabled=!1;var d=.001*Math.floor(50*Math.random());0>=d&&(d=.4);var e=b.height*d,f=b.width*d;try{c.drawImage(b,0,0,f,e)}catch(g){return void console.log("ERROR",g)}var h=c.getImageData(0,0,f,e);return h},blur:function(a){return this.convolution(a,[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9])},scanlines:function(a,b){var c=b.getContext("2d");for(c.putImageData(a,0,0),c.fillStyle="rgb(255,255,255)",i=0;i<b.height;i+=3)c.fillRect(0,i,b.width,2);var d=c.getImageData(0,0,b.width,b.height);return d},convolution:function(a,b,c){for(var d=Math.round(Math.sqrt(b.length)),e=Math.floor(d/2),f=a.data,g=a.width,h=a.height,i=g,j=h,k=document.createElement("canvas").getContext("2d"),l=k.createImageData(i,j),m=l.data,n=c?1:0,o=0;j>o;o++)for(var p=0;i>p;p++){for(var q=o,r=p,s=4*(o*i+p),t=0,u=0,v=0,w=0,x=0;d>x;x++)for(var y=0;d>y;y++){var z=q+x-e,A=r+y-e;if(z>=0&&h>z&&A>=0&&g>A){var B=4*(z*g+A),C=b[x*d+y];t+=f[B]*C,u+=f[B+1]*C,v+=f[B+2]*C,w+=f[B+3]*C}}m[s]=t,m[s+1]=u,m[s+2]=v,m[s+3]=w+n*(255-w)}return l}}};var Glitch=function(a,b,c){this.options=JS.merge({animationLength:500,animationFrames:30,delay:1e4,filters:["scanlines","glitch","brightness"]},c),this.el=document.querySelectorAll(a)[0],JS.addClass(this.el,"glitch"),this.canvas=document.createElement("canvas"),JS.addClass(this.canvas,"glitch-canvas"),this.context=this.canvas.getContext("2d"),this.images=b,this.init()};Glitch.prototype={init:function(){this.currentImageIndex=0,this.firstRun=!0,this.reverseImages=!1,this.appendCanvas(),this.drawImage()},appendCanvas:function(){this.canvas.setAttribute("width",1900),this.canvas.setAttribute("height",1080),this.el.insertBefore(this.canvas,this.el.firstChild)},selectImage:function(){return this.images[Math.floor(Math.random()*this.images.length)]},drawImage:function(){this.isStopped=!1;var a=new Image;a.src=this.selectImage(),a.onload=function(){this.createFilteredImages(a)}.bind(this)},applyDataToCanvas:function(a,b){b=b||0,this.setCanvasClass(a),this.context.putImageData(a,b,0)},setCanvasClass:function(a){return a.height<a.width?this.canvas.setAttribute("class","glitch-wide glitch-canvas"):this.canvas.setAttribute("class","glitch-tall glitch-canvas")},intervalLength:function(){var a=this.reverseImages||0!==this.currentImageIndex?this.options.animationLength/(this.options.animationFrames+1):Math.floor(Math.random()*this.options.delay);return a},createFilteredImages:function(a){for(var b=[],c=0;c<this.options.animationFrames;c++){var d=0===c?["unfiltered"]:this.options.filters;b[c]=this.filterImage(a,d,c)}this.firstRun&&(this.applyDataToCanvas(b[0]),this.firstRun=!1),this.lastArray=this.filteredArray||b,this.filteredArray=b,this.animate(b)},animate:function(a){if(this.isStopped)return!1;var b=this.currentImageIndex;b<a.length?setTimeout(function(){var c=a[b],d=0===b?0:Math.floor(c.width/b);0===b&&(this.canvas.setAttribute("width",c.width),this.canvas.setAttribute("height",c.height));this.options.slide?this.slide(c,this.lastArray[b],d):this.applyDataToCanvas(c);this.currentImageIndex++,this.animate(a)}.bind(this),this.intervalLength()):(this.currentImageIndex=0,this.applyDataToCanvas(a[0]),this.drawImage())},slide:function(a,b,c){this.applyDataToCanvas(a,c),this.applyDataToCanvas(b,c-b.width)},stop:function(){this.isStopped=!0},start:function(){this.drawImage()},filterImage:function(a,b,c){var d=new Filter(a,c);return d.applyFilters(b,c)},grayscaleImage:function(){var a=new Filter(this.filteredArray[0]);this.applyDataToCanvas(a.filters.grayscale(a.image,a.canvas,0))},rollDice:function(a){return 0===Math.floor(Math.random()*a)}};var JS={merge:function(a,b){for(var c in b)a[c]=b[c];return a},size:function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},addClass:function(a,b){classNames=b.split(" "),classNames.forEach(function(b){a.classList.contains(b)||(a.className+=" "+b)})},removeClass:function(a,b){classNames=b.split(" "),classNames.forEach(function(b){regex=new RegExp("(?:^|\\s)"+b+"(?!\\S)","g"),a.className=a.className.replace(regex,"")})}};